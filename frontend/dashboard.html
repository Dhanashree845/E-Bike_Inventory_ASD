<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard â€“ E-Bike Inventory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="app-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h2>âš¡ InnovaBike</h2>
      <span>Admin Panel</span>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Main</div>
      <div class="nav-item active" data-page="dashboard" onclick="location.href='dashboard.html'"><span class="icon">ğŸ“Š</span> Dashboard</div>
      <div class="nav-item" data-page="bikes" onclick="location.href='bikes.html'"><span class="icon">ğŸš²</span> Bikes</div>
      <div class="nav-item" data-page="customers" onclick="location.href='customers.html'"><span class="icon">ğŸ‘¥</span> Customers</div>
      <div class="nav-section-label">Operations</div>
      <div class="nav-item" data-page="suppliers" onclick="location.href='suppliers.html'"><span class="icon">ğŸ­</span> Suppliers</div>
      <div class="nav-item" data-page="purchases" onclick="location.href='purchases.html'"><span class="icon">ğŸ“¦</span> Purchases</div>
      <div class="nav-item" data-page="sales" onclick="location.href='sales.html'"><span class="icon">ğŸ’°</span> Sales</div>
      <div class="nav-section-label">Reports</div>
      <div class="nav-item" data-page="reports" onclick="location.href='reports.html'"><span class="icon">ğŸ“ˆ</span> Reports</div>
      <div class="nav-item" data-page="stock-history" onclick="location.href='stock-history.html'"><span class="icon">ğŸ—‚ï¸</span> Stock History</div>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-content">
    <div class="topbar">
      <span class="topbar-title">Admin Dashboard</span>
      <div class="topbar-right">
        <span class="topbar-role" id="topbar-role"></span>
      </div>
    </div>

    <div class="page-content">
      <div class="page-header">
        <h1>Overview</h1>
      </div>

      <!-- STATS -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><div class="stat-card-label">Total Bikes</div><div class="stat-card-value" id="s-bikes">â€”</div></div>
        <div class="stat-card green"><div class="stat-card-label">Total Customers</div><div class="stat-card-value" id="s-customers">â€”</div></div>
        <div class="stat-card cyan"><div class="stat-card-label">Total Sales</div><div class="stat-card-value" id="s-sales">â€”</div></div>
        <div class="stat-card yellow"><div class="stat-card-label">Total Purchases</div><div class="stat-card-value" id="s-purchases">â€”</div></div>
        <div class="stat-card green"><div class="stat-card-label">Total Revenue</div><div class="stat-card-value" id="s-revenue">â€”</div></div>
        <div class="stat-card"><div class="stat-card-label">Total Stock</div><div class="stat-card-value" id="s-stock">â€”</div></div>
        <div class="stat-card red"><div class="stat-card-label">Low Stock Items</div><div class="stat-card-value" id="s-lowstock">â€”</div></div>
      </div>

      <!-- RECENT SALES -->
      <div class="card">
        <div class="card-header">
          <h2>Recent Sales</h2>
          <a href="sales.html" class="btn btn-outline btn-sm">View All</a>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Customer</th><th>Bike ID</th><th>Qty</th><th>Total</th><th>Status</th><th>Date</th></tr></thead>
            <tbody id="recentSalesBody"><tr><td colspan="6" class="loading">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- LOW STOCK ALERT -->
      <div class="card">
        <div class="card-header">
          <h2>âš ï¸ Low Stock Alert</h2>
          <a href="bikes.html" class="btn btn-outline btn-sm">Manage Bikes</a>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Bike ID</th><th>Name</th><th>Brand</th><th>Stock</th><th>Min Stock</th></tr></thead>
            <tbody id="lowStockBody"><tr><td colspan="5" class="loading">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<script src="api.js"></script>
<script>
  if (!requireAuth(['ADMIN'])) {}
  initTopbar();

  async function loadDashboard() {
    try {
      const [bikesRes, customersRes, salesRes, purchasesRes] = await Promise.all([
        API.get('/bikes'), API.get('/customers'), API.get('/sales'), API.get('/purchases')
      ]);
      const bikes     = bikesRes.data || [];
      const customers = customersRes.data || [];
      const sales     = salesRes.data || [];
      const purchases = purchasesRes.data || [];

      const revenue  = sales.reduce((s, x) => s + (x.totalAmount || 0), 0);
      const stock    = bikes.reduce((s, x) => s + (x.stock || 0), 0);
      const lowStock = bikes.filter(b => b.stock <= b.minimumStock);

      document.getElementById('s-bikes').textContent     = bikes.length;
      document.getElementById('s-customers').textContent = customers.length;
      document.getElementById('s-sales').textContent     = sales.length;
      document.getElementById('s-purchases').textContent = purchases.length;
      document.getElementById('s-revenue').textContent   = fmtCurrency(revenue);
      document.getElementById('s-stock').textContent     = stock;
      document.getElementById('s-lowstock').textContent  = lowStock.length;

      // Recent sales (last 5)
      const recentSales = sales.slice(0, 5);
      const salesBody = document.getElementById('recentSalesBody');
      salesBody.innerHTML = recentSales.length ? recentSales.map(s => `
        <tr>
          <td>${s.customer}</td>
          <td>${s.bikeId}</td>
          <td>${s.quantity}</td>
          <td>${fmtCurrency(s.totalAmount)}</td>
          <td><span class="badge ${s.paymentStatus === 'PAID' ? 'badge-success' : 'badge-warning'}">${s.paymentStatus}</span></td>
          <td>${fmtDate(s.saleDate || s.createdAt)}</td>
        </tr>`).join('') : '<tr><td colspan="6" class="empty-state"><p>No sales yet</p></td></tr>';

      // Low stock
      const lowBody = document.getElementById('lowStockBody');
      lowBody.innerHTML = lowStock.length ? lowStock.map(b => `
        <tr>
          <td>${b.bikeId}</td>
          <td>${b.name}</td>
          <td>${b.brand}</td>
          <td><span class="badge badge-danger">${b.stock}</span></td>
          <td>${b.minimumStock}</td>
        </tr>`).join('') : '<tr><td colspan="5" style="text-align:center;padding:20px;color:#64748b">âœ… All bikes have sufficient stock</td></tr>';

    } catch (err) {
      toast('Failed to load dashboard data', 'error');
    }
  }

  loadDashboard();
</script>
</body>
</html>
