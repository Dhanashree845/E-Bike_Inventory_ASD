<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Purchases ‚Äì E-Bike Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>‚ö° InnovaBike</h2><span>Admin Panel</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-label">Main</div>
                <div class="nav-item" onclick="location.href='dashboard.html'"><span class="icon">üìä</span> Dashboard
                </div>
                <div class="nav-item" onclick="location.href='bikes.html'"><span class="icon">üö≤</span> Bikes</div>
                <div class="nav-item" onclick="location.href='customers.html'"><span class="icon">üë•</span> Customers
                </div>
                <div class="nav-section-label">Operations</div>
                <div class="nav-item" onclick="location.href='suppliers.html'"><span class="icon">üè≠</span> Suppliers
                </div>
                <div class="nav-item active"><span class="icon">üì¶</span> Purchases</div>
                <div class="nav-item" onclick="location.href='sales.html'"><span class="icon">üí∞</span> Sales</div>
                <div class="nav-section-label">Reports</div>
                <div class="nav-item" onclick="location.href='reports.html'"><span class="icon">üìà</span> Reports</div>
                <div class="nav-item" onclick="location.href='stock-history.html'"><span class="icon">üóÇÔ∏è</span> Stock
                    History</div>
            </nav>
            <div class="sidebar-footer"><button class="logout-btn" onclick="logout()">üö™ Logout</button></div>
        </aside>
        <div class="main-content">
            <div class="topbar">
                <span class="topbar-title">Purchase Management</span>
                <div class="topbar-right"><span class="topbar-role" id="topbar-role"></span></div>
            </div>
            <div class="page-content">
                <div class="page-header">
                    <h1>üì¶ Purchases</h1>
                    <button class="btn btn-primary" onclick="openModal('purchaseModal')">+ Record Purchase</button>
                </div>
                <div class="card">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th>Bike ID</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchasesBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading‚Ä¶</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="purchaseModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Purchase</h3>
                <button class="modal-close" onclick="closeModal('purchaseModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group"><label>Supplier Name *</label><input id="f-supplier"
                            placeholder="Supplier Co." /></div>
                    <div class="form-group">
                        <label>Bike *</label>
                        <select id="f-bikeId">
                            <option value="">Select Bike‚Ä¶</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Quantity *</label><input type="number" id="f-qty" placeholder="10"
                            min="1" /></div>
                    <div class="form-group"><label>Unit Price (‚Çπ) *</label><input type="number" id="f-price"
                            placeholder="40000" /></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('purchaseModal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePurchase()">Record</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="api.js"></script>
    <script>
        requireAuth(['ADMIN']);
        initTopbar();

        async function loadBikesDropdown() {
            try {
                const res = await API.get('/bikes');
                const sel = document.getElementById('f-bikeId');
                (res.data || []).forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.bikeId;
                    opt.textContent = `${b.bikeId} ‚Äì ${b.name}`;
                    sel.appendChild(opt);
                });
            } catch (e) { }
        }

        async function loadPurchases() {
            try {
                const res = await API.get('/purchases');
                const purchases = res.data || [];
                const body = document.getElementById('purchasesBody');
                if (!purchases.length) {
                    body.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">üì¶</div><p>No purchases yet</p></div></td></tr>';
                    return;
                }
                body.innerHTML = purchases.map(p => `
        <tr>
          <td>${p.supplierName}</td>
          <td>${p.bikeId}</td>
          <td>${p.quantity}</td>
          <td>${fmtCurrency(p.price)}</td>
          <td><strong>${fmtCurrency(p.totalAmount)}</strong></td>
          <td>${fmtDate(p.purchaseDate || p.createdAt)}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deletePurchase('${p._id}')">üóëÔ∏è</button></td>
        </tr>`).join('');
            } catch (e) { toast('Failed to load purchases', 'error'); }
        }

        async function savePurchase() {
            const body = {
                supplierName: document.getElementById('f-supplier').value.trim(),
                bikeId: document.getElementById('f-bikeId').value,
                quantity: Number(document.getElementById('f-qty').value),
                price: Number(document.getElementById('f-price').value),
            };
            if (!body.supplierName || !body.bikeId || !body.quantity || !body.price) {
                toast('All fields are required', 'error'); return;
            }
            try {
                await API.post('/purchases', body);
                toast('Purchase recorded! Stock updated.');
                closeModal('purchaseModal');
                document.getElementById('f-supplier').value = '';
                document.getElementById('f-bikeId').value = '';
                document.getElementById('f-qty').value = '';
                document.getElementById('f-price').value = '';
                loadPurchases();
            } catch (e) { toast(e.message, 'error'); }
        }

        async function deletePurchase(id) {
            if (!confirm('Delete this purchase record?')) return;
            try { await API.delete(`/purchases/${id}`); toast('Purchase deleted'); loadPurchases(); }
            catch (e) { toast(e.message, 'error'); }
        }

        loadBikesDropdown();
        loadPurchases();
    </script>
</body>

</html>