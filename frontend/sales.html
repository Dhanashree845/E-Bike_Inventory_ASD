<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales ‚Äì E-Bike Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>‚ö° InnovaBike</h2><span id="sidebar-role-label">Panel</span>
            </div>
            <nav class="sidebar-nav" id="sidebar-nav"></nav>
            <div class="sidebar-footer"><button class="logout-btn" onclick="logout()">üö™ Logout</button></div>
        </aside>
        <div class="main-content">
            <div class="topbar">
                <span class="topbar-title">Sales Management</span>
                <div class="topbar-right"><span class="topbar-role" id="topbar-role"></span></div>
            </div>
            <div class="page-content">
                <div class="page-header">
                    <h1>üí∞ Sales</h1>
                    <button class="btn btn-primary" onclick="openModal('saleModal')">+ Record Sale</button>
                </div>
                <div class="card">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Bike ID</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Payment</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="salesBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading‚Ä¶</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="saleModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Sale</h3>
                <button class="modal-close" onclick="closeModal('saleModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group"><label>Customer Name *</label><input id="f-customer"
                            placeholder="John Doe" /></div>
                    <div class="form-group">
                        <label>Bike *</label>
                        <select id="f-bikeId">
                            <option value="">Select Bike‚Ä¶</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Quantity *</label><input type="number" id="f-qty" placeholder="1"
                            min="1" /></div>
                    <div class="form-group"><label>Unit Price (‚Çπ) *</label><input type="number" id="f-price"
                            placeholder="45000" /></div>
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="f-payment">
                            <option value="PAID">PAID</option>
                            <option value="PENDING">PENDING</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('saleModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveSale()">Record Sale</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="api.js"></script>
    <script>
        requireAuth(['ADMIN', 'STAFF']);
        initTopbar();

        const role = getRole();
        document.getElementById('sidebar-role-label').textContent = role === 'ADMIN' ? 'Admin Panel' : 'Staff Panel';
        document.getElementById('sidebar-nav').innerHTML = role === 'ADMIN' ? `
    <div class="nav-section-label">Main</div>
    <div class="nav-item" onclick="location.href='dashboard.html'"><span class="icon">üìä</span> Dashboard</div>
    <div class="nav-item" onclick="location.href='bikes.html'"><span class="icon">üö≤</span> Bikes</div>
    <div class="nav-item" onclick="location.href='customers.html'"><span class="icon">üë•</span> Customers</div>
    <div class="nav-section-label">Operations</div>
    <div class="nav-item" onclick="location.href='suppliers.html'"><span class="icon">üè≠</span> Suppliers</div>
    <div class="nav-item" onclick="location.href='purchases.html'"><span class="icon">üì¶</span> Purchases</div>
    <div class="nav-item active"><span class="icon">üí∞</span> Sales</div>
    <div class="nav-section-label">Reports</div>
    <div class="nav-item" onclick="location.href='reports.html'"><span class="icon">üìà</span> Reports</div>
    <div class="nav-item" onclick="location.href='stock-history.html'"><span class="icon">üóÇÔ∏è</span> Stock History</div>` : `
    <div class="nav-section-label">Main</div>
    <div class="nav-item" onclick="location.href='staff-dashboard.html'"><span class="icon">üìä</span> Dashboard</div>
    <div class="nav-item" onclick="location.href='bikes.html'"><span class="icon">üö≤</span> Bikes</div>
    <div class="nav-item" onclick="location.href='customers.html'"><span class="icon">üë•</span> Customers</div>
    <div class="nav-item active"><span class="icon">üí∞</span> Sales</div>`;

        async function loadBikesDropdown() {
            try {
                const res = await API.get('/bikes');
                const sel = document.getElementById('f-bikeId');
                (res.data || []).forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.bikeId;
                    opt.textContent = `${b.bikeId} ‚Äì ${b.name} (Stock: ${b.stock})`;
                    sel.appendChild(opt);
                });
            } catch (e) { }
        }

        async function loadSales() {
            try {
                const res = await API.get('/sales');
                const sales = res.data || [];
                const body = document.getElementById('salesBody');
                if (!sales.length) {
                    body.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">üí∞</div><p>No sales yet</p></div></td></tr>';
                    return;
                }
                body.innerHTML = sales.map(s => `
        <tr>
          <td>${s.customer}</td>
          <td>${s.bikeId}</td>
          <td>${s.quantity}</td>
          <td>${fmtCurrency(s.price)}</td>
          <td><strong>${fmtCurrency(s.totalAmount)}</strong></td>
          <td><span class="badge ${s.paymentStatus === 'PAID' ? 'badge-success' : 'badge-warning'}">${s.paymentStatus}</span></td>
          <td>${fmtDate(s.saleDate || s.createdAt)}</td>
        </tr>`).join('');
            } catch (e) { toast('Failed to load sales', 'error'); }
        }

        async function saveSale() {
            const body = {
                customer: document.getElementById('f-customer').value.trim(),
                bikeId: document.getElementById('f-bikeId').value,
                quantity: Number(document.getElementById('f-qty').value),
                price: Number(document.getElementById('f-price').value),
                paymentStatus: document.getElementById('f-payment').value,
            };
            if (!body.customer || !body.bikeId || !body.quantity || !body.price) {
                toast('All fields are required', 'error'); return;
            }
            try {
                await API.post('/sales', body);
                toast('Sale recorded! Stock updated.');
                closeModal('saleModal');
                document.getElementById('f-customer').value = '';
                document.getElementById('f-bikeId').value = '';
                document.getElementById('f-qty').value = '';
                document.getElementById('f-price').value = '';
                loadSales();
            } catch (e) { toast(e.message, 'error'); }
        }

        loadBikesDropdown();
        loadSales();
    </script>
</body>

</html>