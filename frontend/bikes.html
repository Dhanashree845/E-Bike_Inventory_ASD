<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bikes â€“ E-Bike Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>âš¡ InnovaBike</h2><span id="sidebar-role-label">Admin Panel</span>
            </div>
            <nav class="sidebar-nav" id="sidebar-nav"></nav>
            <div class="sidebar-footer"><button class="logout-btn" onclick="logout()">ğŸšª Logout</button></div>
        </aside>
        <div class="main-content">
            <div class="topbar">
                <span class="topbar-title">Bike Management</span>
                <div class="topbar-right"><span class="topbar-role" id="topbar-role"></span></div>
            </div>
            <div class="page-content">
                <div class="page-header">
                    <h1>ğŸš² Bikes</h1>
                    <button class="btn btn-primary" onclick="openModal('bikeModal')">+ Add Bike</button>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by name, brand, modelâ€¦"
                        oninput="filterBikes()" />
                </div>

                <div class="card">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Bike ID</th>
                                    <th>Name</th>
                                    <th>Brand</th>
                                    <th>Model</th>
                                    <th>Battery</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bikesBody">
                                <tr>
                                    <td colspan="10" class="loading">Loadingâ€¦</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BIKE MODAL -->
    <div class="modal-overlay" id="bikeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Bike</h3>
                <button class="modal-close" onclick="closeModal('bikeModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group"><label>Bike ID *</label><input id="f-bikeId" placeholder="BK001" /></div>
                    <div class="form-group"><label>Name *</label><input id="f-name" placeholder="Thunder X1" /></div>
                    <div class="form-group"><label>Brand *</label><input id="f-brand" placeholder="Hero" /></div>
                    <div class="form-group"><label>Model *</label><input id="f-model" placeholder="2024" /></div>
                    <div class="form-group"><label>Battery Capacity *</label><input id="f-battery"
                            placeholder="48V 20Ah" /></div>
                    <div class="form-group"><label>Price (â‚¹) *</label><input type="number" id="f-price"
                            placeholder="45000" /></div>
                    <div class="form-group"><label>Stock *</label><input type="number" id="f-stock" placeholder="10" />
                    </div>
                    <div class="form-group"><label>Min Stock</label><input type="number" id="f-minStock" value="5" />
                    </div>
                    <div class="form-group"><label>Range (KM)</label><input type="number" id="f-range"
                            placeholder="80" /></div>
                    <div class="form-group"><label>Warranty (Months)</label><input type="number" id="f-warranty"
                            placeholder="12" /></div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="f-status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Image</label><input type="file" id="f-image" accept="image/*" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bikeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBike()">Save Bike</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="api.js"></script>
    <script>
        requireAuth(['ADMIN', 'STAFF']);
        initTopbar();
        buildSidebar();

        let allBikes = [];
        let editId = null;

        function buildSidebar() {
            const role = getRole();
            document.getElementById('sidebar-role-label').textContent = role === 'ADMIN' ? 'Admin Panel' : 'Staff Panel';
            const nav = document.getElementById('sidebar-nav');
            if (role === 'ADMIN') {
                nav.innerHTML = `
        <div class="nav-section-label">Main</div>
        <div class="nav-item" onclick="location.href='dashboard.html'"><span class="icon">ğŸ“Š</span> Dashboard</div>
        <div class="nav-item active" data-page="bikes"><span class="icon">ğŸš²</span> Bikes</div>
        <div class="nav-item" onclick="location.href='customers.html'"><span class="icon">ğŸ‘¥</span> Customers</div>
        <div class="nav-section-label">Operations</div>
        <div class="nav-item" onclick="location.href='suppliers.html'"><span class="icon">ğŸ­</span> Suppliers</div>
        <div class="nav-item" onclick="location.href='purchases.html'"><span class="icon">ğŸ“¦</span> Purchases</div>
        <div class="nav-item" onclick="location.href='sales.html'"><span class="icon">ğŸ’°</span> Sales</div>
        <div class="nav-section-label">Reports</div>
        <div class="nav-item" onclick="location.href='reports.html'"><span class="icon">ğŸ“ˆ</span> Reports</div>
        <div class="nav-item" onclick="location.href='stock-history.html'"><span class="icon">ğŸ—‚ï¸</span> Stock History</div>`;
            } else {
                nav.innerHTML = `
        <div class="nav-section-label">Main</div>
        <div class="nav-item" onclick="location.href='staff-dashboard.html'"><span class="icon">ğŸ“Š</span> Dashboard</div>
        <div class="nav-item active"><span class="icon">ğŸš²</span> Bikes</div>
        <div class="nav-item" onclick="location.href='customers.html'"><span class="icon">ğŸ‘¥</span> Customers</div>
        <div class="nav-item" onclick="location.href='sales.html'"><span class="icon">ğŸ’°</span> Sales</div>`;
            }
        }

        async function loadBikes() {
            try {
                const res = await API.get('/bikes');
                allBikes = res.data || [];
                renderBikes(allBikes);
            } catch (e) { toast('Failed to load bikes', 'error'); }
        }

        function renderBikes(bikes) {
            const role = getRole();
            const body = document.getElementById('bikesBody');
            if (!bikes.length) {
                body.innerHTML = '<tr><td colspan="10"><div class="empty-state"><div class="icon">ğŸš²</div><p>No bikes found</p></div></td></tr>';
                return;
            }
            body.innerHTML = bikes.map(b => `
      <tr>
        <td>${b.image ? `<img class="bike-img" src="http://localhost:7000${b.image}" alt="bike"/>` : '<div class="no-img">No img</div>'}</td>
        <td><strong>${b.bikeId}</strong></td>
        <td>${b.name}</td>
        <td>${b.brand}</td>
        <td>${b.model}</td>
        <td>${b.batteryCapacity}</td>
        <td>${fmtCurrency(b.price)}</td>
        <td>${b.stock <= b.minimumStock
                    ? `<span class="badge badge-danger">${b.stock}</span>`
                    : `<span class="badge badge-success">${b.stock}</span>`}</td>
        <td><span class="badge ${b.status === 'active' ? 'badge-success' : 'badge-gray'}">${b.status}</span></td>
        <td>
          ${role === 'ADMIN' ? `
          <button class="btn btn-warning btn-sm" onclick="editBike('${b._id}')">âœï¸ Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteBike('${b._id}')">ğŸ—‘ï¸</button>` : 'â€”'}
        </td>
      </tr>`).join('');
        }

        function filterBikes() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderBikes(allBikes.filter(b =>
                b.name.toLowerCase().includes(q) ||
                b.brand.toLowerCase().includes(q) ||
                b.model.toLowerCase().includes(q) ||
                b.bikeId.toLowerCase().includes(q)
            ));
        }

        function editBike(id) {
            const b = allBikes.find(x => x._id === id);
            if (!b) return;
            editId = id;
            document.getElementById('modalTitle').textContent = 'Edit Bike';
            document.getElementById('f-bikeId').value = b.bikeId;
            document.getElementById('f-name').value = b.name;
            document.getElementById('f-brand').value = b.brand;
            document.getElementById('f-model').value = b.model;
            document.getElementById('f-battery').value = b.batteryCapacity;
            document.getElementById('f-price').value = b.price;
            document.getElementById('f-stock').value = b.stock;
            document.getElementById('f-minStock').value = b.minimumStock;
            document.getElementById('f-range').value = b.rangeKm || '';
            document.getElementById('f-warranty').value = b.warrantyMonths || '';
            document.getElementById('f-status').value = b.status;
            openModal('bikeModal');
        }

        async function saveBike() {
            const fd = new FormData();
            fd.append('bikeId', document.getElementById('f-bikeId').value);
            fd.append('name', document.getElementById('f-name').value);
            fd.append('brand', document.getElementById('f-brand').value);
            fd.append('model', document.getElementById('f-model').value);
            fd.append('batteryCapacity', document.getElementById('f-battery').value);
            fd.append('price', document.getElementById('f-price').value);
            fd.append('stock', document.getElementById('f-stock').value);
            fd.append('minimumStock', document.getElementById('f-minStock').value);
            fd.append('rangeKm', document.getElementById('f-range').value);
            fd.append('warrantyMonths', document.getElementById('f-warranty').value);
            fd.append('status', document.getElementById('f-status').value);
            const img = document.getElementById('f-image').files[0];
            if (img) fd.append('image', img);

            try {
                if (editId) {
                    await API.put(`/bikes/${editId}`, fd, true);
                    toast('Bike updated!');
                } else {
                    await API.post('/bikes', fd, true);
                    toast('Bike added!');
                }
                closeModal('bikeModal');
                resetForm();
                loadBikes();
            } catch (e) { toast(e.message, 'error'); }
        }

        async function deleteBike(id) {
            if (!confirm('Delete this bike?')) return;
            try {
                await API.delete(`/bikes/${id}`);
                toast('Bike deleted');
                loadBikes();
            } catch (e) { toast(e.message, 'error'); }
        }

        function resetForm() {
            editId = null;
            document.getElementById('modalTitle').textContent = 'Add New Bike';
            ['f-bikeId', 'f-name', 'f-brand', 'f-model', 'f-battery', 'f-price', 'f-stock', 'f-range', 'f-warranty'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('f-minStock').value = '5';
            document.getElementById('f-status').value = 'active';
            document.getElementById('f-image').value = '';
        }

        document.getElementById('bikeModal').addEventListener('click', e => {
            if (e.target === document.getElementById('bikeModal')) { closeModal('bikeModal'); resetForm(); }
        });

        loadBikes();
    </script>
</body>

</html>