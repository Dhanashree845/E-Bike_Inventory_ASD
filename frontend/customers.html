<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customers â€“ E-Bike Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>âš¡ InnovaBike</h2><span id="sidebar-role-label">Panel</span>
            </div>
            <nav class="sidebar-nav" id="sidebar-nav"></nav>
            <div class="sidebar-footer"><button class="logout-btn" onclick="logout()">ğŸšª Logout</button></div>
        </aside>
        <div class="main-content">
            <div class="topbar">
                <span class="topbar-title">Customer Management</span>
                <div class="topbar-right"><span class="topbar-role" id="topbar-role"></span></div>
            </div>
            <div class="page-content">
                <div class="page-header">
                    <h1>ğŸ‘¥ Customers</h1>
                    <button class="btn btn-primary" onclick="openAddModal()">+ Add Customer</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by name, emailâ€¦"
                        oninput="filterCustomers()" />
                </div>
                <div class="card">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Address</th>
                                    <th>Bike Model</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersBody">
                                <tr>
                                    <td colspan="6" class="loading">Loadingâ€¦</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="customerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Add Customer</h3>
                <button class="modal-close" onclick="closeModal('customerModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group"><label>Name *</label><input id="f-name" placeholder="John Doe" /></div>
                    <div class="form-group"><label>Email *</label><input type="email" id="f-email"
                            placeholder="john@email.com" /></div>
                    <div class="form-group"><label>Phone *</label><input id="f-phone" placeholder="+91 9876543210" />
                    </div>
                    <div class="form-group"><label>Address</label><input id="f-address" placeholder="City, State" />
                    </div>
                    <div class="form-group"><label>Bike Model</label><input id="f-bikeModel" placeholder="Thunder X1" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('customerModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveCustomer()">Save</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="api.js"></script>
    <script>
        requireAuth(['ADMIN', 'STAFF']);
        initTopbar();

        const role = getRole();
        document.getElementById('sidebar-role-label').textContent = role === 'ADMIN' ? 'Admin Panel' : 'Staff Panel';
        document.getElementById('sidebar-nav').innerHTML = role === 'ADMIN' ? `
    <div class="nav-section-label">Main</div>
    <div class="nav-item" onclick="location.href='dashboard.html'"><span class="icon">ğŸ“Š</span> Dashboard</div>
    <div class="nav-item" onclick="location.href='bikes.html'"><span class="icon">ğŸš²</span> Bikes</div>
    <div class="nav-item active"><span class="icon">ğŸ‘¥</span> Customers</div>
    <div class="nav-section-label">Operations</div>
    <div class="nav-item" onclick="location.href='suppliers.html'"><span class="icon">ğŸ­</span> Suppliers</div>
    <div class="nav-item" onclick="location.href='purchases.html'"><span class="icon">ğŸ“¦</span> Purchases</div>
    <div class="nav-item" onclick="location.href='sales.html'"><span class="icon">ğŸ’°</span> Sales</div>
    <div class="nav-section-label">Reports</div>
    <div class="nav-item" onclick="location.href='reports.html'"><span class="icon">ğŸ“ˆ</span> Reports</div>
    <div class="nav-item" onclick="location.href='stock-history.html'"><span class="icon">ğŸ—‚ï¸</span> Stock History</div>` : `
    <div class="nav-section-label">Main</div>
    <div class="nav-item" onclick="location.href='staff-dashboard.html'"><span class="icon">ğŸ“Š</span> Dashboard</div>
    <div class="nav-item" onclick="location.href='bikes.html'"><span class="icon">ğŸš²</span> Bikes</div>
    <div class="nav-item active"><span class="icon">ğŸ‘¥</span> Customers</div>
    <div class="nav-item" onclick="location.href='sales.html'"><span class="icon">ğŸ’°</span> Sales</div>`;

        let allCustomers = [], editId = null;

        async function loadCustomers() {
            try {
                const res = await API.get('/customers');
                allCustomers = res.data || [];
                renderCustomers(allCustomers);
            } catch (e) { toast('Failed to load customers', 'error'); }
        }

        function renderCustomers(list) {
            const body = document.getElementById('customersBody');
            if (!list.length) {
                body.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="icon">ğŸ‘¥</div><p>No customers found</p></div></td></tr>';
                return;
            }
            body.innerHTML = list.map(c => `
      <tr>
        <td><strong>${c.name}</strong></td>
        <td>${c.email}</td>
        <td>${c.phone}</td>
        <td>${c.address || 'â€”'}</td>
        <td>${c.bikeModel || 'â€”'}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editCustomer('${c._id}')">âœï¸ Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${c._id}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`).join('');
        }

        function filterCustomers() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderCustomers(allCustomers.filter(c =>
                c.name.toLowerCase().includes(q) || c.email.toLowerCase().includes(q)
            ));
        }

        function openAddModal() {
            editId = null;
            document.getElementById('modalTitle').textContent = 'Add Customer';
            ['f-name', 'f-email', 'f-phone', 'f-address', 'f-bikeModel'].forEach(id => document.getElementById(id).value = '');
            openModal('customerModal');
        }

        function editCustomer(id) {
            const c = allCustomers.find(x => x._id === id);
            if (!c) return;
            editId = id;
            document.getElementById('modalTitle').textContent = 'Edit Customer';
            document.getElementById('f-name').value = c.name;
            document.getElementById('f-email').value = c.email;
            document.getElementById('f-phone').value = c.phone;
            document.getElementById('f-address').value = c.address || '';
            document.getElementById('f-bikeModel').value = c.bikeModel || '';
            openModal('customerModal');
        }

        async function saveCustomer() {
            const body = {
                name: document.getElementById('f-name').value.trim(),
                email: document.getElementById('f-email').value.trim(),
                phone: document.getElementById('f-phone').value.trim(),
                address: document.getElementById('f-address').value.trim(),
                bikeModel: document.getElementById('f-bikeModel').value.trim(),
            };
            if (!body.name || !body.email || !body.phone) { toast('Name, email and phone are required', 'error'); return; }
            try {
                if (editId) { await API.put(`/customers/${editId}`, body); toast('Customer updated!'); }
                else { await API.post('/customers', body); toast('Customer added!'); }
                closeModal('customerModal');
                loadCustomers();
            } catch (e) { toast(e.message, 'error'); }
        }

        async function deleteCustomer(id) {
            if (!confirm('Delete this customer?')) return;
            try { await API.delete(`/customers/${id}`); toast('Customer deleted'); loadCustomers(); }
            catch (e) { toast(e.message, 'error'); }
        }

        loadCustomers();
    </script>
</body>

</html>