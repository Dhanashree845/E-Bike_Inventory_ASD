<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock History ‚Äì E-Bike Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>‚ö° InnovaBike</h2><span>Admin Panel</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-label">Main</div>
                <div class="nav-item" onclick="location.href='dashboard.html'"><span class="icon">üìä</span> Dashboard
                </div>
                <div class="nav-item" onclick="location.href='bikes.html'"><span class="icon">üö≤</span> Bikes</div>
                <div class="nav-item" onclick="location.href='customers.html'"><span class="icon">üë•</span> Customers
                </div>
                <div class="nav-section-label">Operations</div>
                <div class="nav-item" onclick="location.href='suppliers.html'"><span class="icon">üè≠</span> Suppliers
                </div>
                <div class="nav-item" onclick="location.href='purchases.html'"><span class="icon">üì¶</span> Purchases
                </div>
                <div class="nav-item" onclick="location.href='sales.html'"><span class="icon">üí∞</span> Sales</div>
                <div class="nav-section-label">Reports</div>
                <div class="nav-item" onclick="location.href='reports.html'"><span class="icon">üìà</span> Reports</div>
                <div class="nav-item active"><span class="icon">üóÇÔ∏è</span> Stock History</div>
            </nav>
            <div class="sidebar-footer"><button class="logout-btn" onclick="logout()">üö™ Logout</button></div>
        </aside>
        <div class="main-content">
            <div class="topbar">
                <span class="topbar-title">Stock History</span>
                <div class="topbar-right"><span class="topbar-role" id="topbar-role"></span></div>
            </div>
            <div class="page-content">
                <div class="page-header">
                    <h1>üóÇÔ∏è Stock History</h1>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Filter by Bike ID or reason‚Ä¶"
                        oninput="filterHistory()" />
                    <select id="typeFilter" onchange="filterHistory()"
                        style="padding:9px 12px;border:1.5px solid var(--border);border-radius:7px;font-size:.9rem;outline:none;">
                        <option value="">All Types</option>
                        <option value="IN">IN (Stock Added)</option>
                        <option value="OUT">OUT (Stock Removed)</option>
                    </select>
                </div>
                <div class="card">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Bike ID</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Reason</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                <tr>
                                    <td colspan="5" class="loading">Loading‚Ä¶</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="api.js"></script>
    <script>
        requireAuth(['ADMIN']);
        initTopbar();

        let allHistory = [];

        async function loadHistory() {
            try {
                const res = await API.get('/stockhistory');
                allHistory = res.data || [];
                renderHistory(allHistory);
            } catch (e) { toast('Failed to load stock history', 'error'); }
        }

        function renderHistory(list) {
            const body = document.getElementById('historyBody');
            if (!list.length) {
                body.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="icon">üóÇÔ∏è</div><p>No stock history found</p></div></td></tr>';
                return;
            }
            body.innerHTML = list.map(h => `
      <tr>
        <td><strong>${h.bikeId}</strong></td>
        <td><span class="badge ${h.type === 'IN' ? 'badge-success' : 'badge-danger'}">${h.type}</span></td>
        <td>${h.quantity}</td>
        <td>${h.reason || '‚Äî'}</td>
        <td>${fmtDate(h.createdAt)}</td>
      </tr>`).join('');
        }

        function filterHistory() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            renderHistory(allHistory.filter(h =>
                (!type || h.type === type) &&
                (!q || h.bikeId.toLowerCase().includes(q) || (h.reason || '').toLowerCase().includes(q))
            ));
        }

        loadHistory();
    </script>
</body>

</html>